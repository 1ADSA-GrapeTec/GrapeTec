<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/meusArmazens.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="shortcut icon" href="assets/images/fav.ico" type="image/x-icon">
    <title>GrapeTec</title>
</head>

<body onload="tipoAdm(), gerarDados()">
    <!-- Menu Lateral -->
    <div class="container">
        <div class="menuLateral">
            <div class="links">
                <ul id="ul_navBar">
                    <li class="itemMenu">
                        <a href="visaoGeral.html">
                            <span class="icon"><span class="bi bi-bar-chart-line"></span></span>
                            <span class="link">Visão geral</span>
                        </a>
                    </li>
                    <li class="itemMenu">
                        <a href="meusArmazens.html">
                            <span id="aqui" class="icon"><span class="bi bi-house-door"></span></span>
                            <span id="aqui" class="link">Meus armazéns</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <!-- NAVBAR -->
        <div class="info">
            <div class="navbar">
                <div class="BarraIcon">
                    <img src="assets/img/fav.png" alt="">
                    <h2>GRAPETEC</h2>
                </div>
                <div class="user">
                    <img src="assets/images/IconPessoa.png" alt="">
                    <h3>Olá, <span id="span_nomeUsuario"></span></h3>
                </div>
            </div>
            <!-- HOME -->
            <div class="container02">
                <div class="armazem">
                    <p>Informações do <br>
                        armazém
                    </p>

                    <div class="text">
                        <h1 id="linha">|</h1>
                        <h1>
                            <b>Estado:</b> SP <br>
                            <b>Rua:</b> Lajeado <br>
                            <b>Número: </b> 537 <br>
                            <b>Tipo de vinho:</b> Tinto
                        </h1>
                    </div>
                </div>
                <div id="A">
                    <div class="alerta">
                        <p id="p">
                            Status
                        </p>

                        <div class="text">
                            <h1 id="linha"></h1>
                            <h1></h1>
                        </div>
                    </div>
                </div>
                <div id="B">
                    <div class="tempMedia">
                        <p>Temperatura Média</p>

                        <div class="text">
                            <p>O armázem está com temperatura média de <span
                                    style="font-size: 20px; font-weight: 700; color: rgb(255, 255, 255);"></span><br>
                            </p>
                        </div>

                    </div>
                </div>
                <div id="C">
                    <div class="armazens">
                        <p id="p">
                            Armazens
                        </p>

                        <div class="text">
                            <h1 id="linha"></h1>
                            <h1>
                                <select id="id_armazem">
                                </select>
                            </h1>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container_grafico">
                <div class="grafico">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<script>
    var armazens = JSON.parse(sessionStorage.FK_ARMAZEM);
    armazens.forEach(element => {
        id_armazem.innerHTML += `<option value="${element.fkArmazem}">Rua: ${element.rua} Num: ${element.numero}</option>`;
    });
    function tipoAdm() {
        var tipoUsuario = sessionStorage.TIPO_USUARIO;
        var nomeUsuario = sessionStorage.NOME_USUARIO;

        span_nomeUsuario.innerHTML = nomeUsuario;

        if (tipoUsuario == 'administrador') {
            ul_navBar.innerHTML += `
        <li class="itemMenu">
            <a href="cadastro.html">
                <span class="icon"><span class="bi bi-plus-circle"></span></span>
                <span class="link">Adicionar novo usuário</span>
            </a>
        </li>
        <li class="itemMenu">
            <a href="#">
                <span class="icon"><span class="bi bi-box-arrow-left"></span></span>
                <span class="link">Sair</span>
            </a>
        </li>
        `
        } else {
            ul_navBar.innerHTML += `
        <li class="itemMenu">
            <a href="#">
                <span class="icon"><span class="bi bi-box-arrow-left"></span></span>
                <span class="link">Sair</span>
            </a>
        </li>
        `
        }
    }

    var temp = [];
    var data = [];
    var temp2 = [];
    var temp3 = [];
    var temp4 = [];
    var temp5 = [];
    // for (; temp.length < 24;) {
    //     var temperatura = (Math.random() * 9) + 9;
    //     temp.push(temperatura);
    // }
    //criando as temperaturas dos outros sensores
    //    for (var index = 0; index <= temp.length - 1; index += 1) {
    //         temp2.push(temp[index] * 1.25);
    //          temp3.push(temp[index] * 0.90);
    //         temp4.push(temp[index] * 1.10);
    //         temp5.push(temp[index] * 0.60);
    //     }
    //Criando alguns sensores para teste
    // var idSensor = parseInt((Math.random() * 3) + 1);
    // var Sensores = ['14ºC', '14.5ºC', '13ºC', '13.5ºC'];
    // //calculo de media
    // var tempMedia = (temp[temp.length - 1] + temp2[temp.length - 1] + temp3[temp.length - 1] + temp4[temp.length - 1] + temp5[temp.length - 1]) / 5;

    // if (tempMedia <= 13.9) {
    //     for (var index = 0; index < Sensores.length; index += 1) {
    //         if (idSensor == index + 1) {
    //             A.innerHTML = `<div class="alerta" > 
    //                 <p>
    //                     Status
    //                 </p>

    //                 <div class="text">
    //                     <h1 id="linha">|</h1>
    //                     <h1>
    //                         Crítico frio!
    //                     </h1>
    //                 </div>

    //                 <style> 
    //                 .alerta {
    //                     background-color: red;
    //                 }
    //             </style>`;
    //             B.innerHTML = `<div class="tempMedia">
    //                             <p>
    //                                 Temperatura Média
    //                             </p> 
    //                             <div class="text">
    //                             <p>
    //                                 O armázem está com temperatura média de <span style="font-size: 20px; font-weight: 700; color: red;">${Sensores[index]}</span><br>
    //                             </p>
    //                             </div>
    //                         </div>`
    //         }
    //     }
    // } else if (tempMedia <= 15.4) {
    //     for (var index = 0; index < Sensores.length; index += 1) {
    //         if (idSensor == index + 1) {
    //             A.innerHTML = `<div class="alerta" > 
    //                 <p>
    //                     Status
    //                 </p>

    //                 <div class="text">
    //                     <h1 id="linha">|</h1>
    //                     <h1>
    //                        Alerta Frio!
    //                     </h1>
    //                 </div>

    //                 <style> 
    //                 .alerta {
    //                     background-color: yellow;
    //                 }
    //                 .alerta p {
    //                     color: #4d1132; 
    //                 }
    //                 .alerta h1 {
    //                     color: #4d1132;
    //                 }
    //             </style>`;
    //             B.innerHTML = `<div class="tempMedia">
    //                             <p>
    //                                 Temperatura Média
    //                             </p> 
    //                             <div class="text">
    //                             <p>
    //                                 O armázem está com temperatura média de <span style="font-size: 20px; font-weight: 700; color: yellow;">${Sensores[index]}</span><br>
    //                             </p>
    //                             </div>
    //                         </div>`
    //         }
    //     }
    // } else if (tempMedia <= 15.6) {
    //     for (var index = 0; index < Sensores.length; index += 1) {
    //         if (idSensor == index + 1) {
    //             A.innerHTML = `<div class="alerta" > 
    //                 <p>
    //                     Status
    //                 </p>

    //                 <div class="text">
    //                     <h1 id="linha">|</h1>
    //                     <h1>
    //                         Temperatura estável.
    //                     </h1>
    //                 </div>

    //                 <style> 
    //                 .alerta {
    //                     background-color: green;
    //                 }
    //             </style>`;

    //             B.innerHTML = `<div class="tempMedia">
    //                             <p>
    //                                 Temperatura Média
    //                             </p> 
    //                             <div class="text">
    //                             <p>
    //                                 O armázem está com temperatura média de <span style="font-size: 20px; font-weight: 700; color: green;">${Sensores[index]}</span><br>
    //                             </p>
    //                             </div>
    //                         </div>`
    //         }
    //     }

    // } else if (tempMedia <= 15.8) {
    //     for (var index = 0; index < Sensores.length; index += 1) {
    //         if (idSensor == index + 1) {
    //             A.innerHTML = `<div class="alerta" > 
    //                 <p>
    //                     Status
    //                 </p>

    //                 <div class="text">
    //                     <h1 id="linha">|</h1>
    //                     <h1>
    //                         Alerta quente!
    //                     </h1>
    //                 </div>

    //                 <style> 
    //                 .alerta {
    //                     background-color: yellow;
    //                 }
    //                 .alerta p {
    //                     color: #4d1132; 
    //                 }
    //                 .alerta h1 {
    //                     color: #4d1132;
    //                 }
    //             </style>`;

    //             B.innerHTML = `<div class="tempMedia">
    //                              <p>
    //                                 Temperatura Média
    //                             </p> 
    //                             <div class="text">
    //                             <p>
    //                                 O armázem está com temperatura média de <span style="font-size: 20px; font-weight: 700; color: yellow;">${Sensores[index]}</span><br>
    //                             </p>
    //                             </div>
    //                         </div>`
    //         }
    //     }

    // } else {
    //     for (var index = 0; index < Sensores.length; index += 1) {
    //         if (idSensor == index + 1) {
    //             A.innerHTML = `<div class="alerta" > 
    //                 <p>
    //                     Status
    //                 </p>

    //                 <div class="text">
    //                     <h1 id="linha">|</h1>
    //                     <h1>
    //                         Crítico quente!
    //                     </h1>
    //                 </div>

    //                 <style> 
    //                 .alerta {
    //                     background-color: red;
    //                 }
    //             </style>`;
    //             B.innerHTML = `<div class="tempMedia">
    //                             <p>
    //                                 Temperatura Média
    //                             </p> 
    //                             <div class="text">
    //                             <p>
    //                                 O armázem está com temperatura média de <span style="font-size: 20px; font-weight: 700; color: red;">${Sensores[index]}</span><br>
    //                             </p>
    //                             </div>
    //                         </div>`
    //         }
    //     }
    // };


    var myChart1 = new Chart(document.getElementById('myChart'), {
        type: 'line',
        data: {
            labels: data,
            datasets: [{
                label: 'Sensor 1',
                borderColor: 'rgb(79, 0, 128)',
                backgroundColor: 'rgb(79, 0, 128)',
                data: temp,
                borderWidth: 3,
                borderJoinStyle: 'round',
                pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(75, 192, 192, 1)',
                pointRadius: 0,
                pointHoverRadius: 0,
                borderCapStyle: 'round'
            },
            {
                label: 'Sensor 2',
                borderColor: 'rgb(255, 57, 162)',
                backgroundColor: 'rgb(255, 57, 162)',
                data: temp2,
                borderWidth: 3,
                borderJoinStyle: 'round',
                pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                pointRadius: 0,
                pointHoverRadius: 0,
                borderCapStyle: 'round'
            },
            {
                label: 'Sensor 3',
                borderColor: 'rgb(119, 7, 48)',
                backgroundColor: 'rgb(119, 7, 48)',
                data: temp3,
                borderWidth: 3,
                borderJoinStyle: 'round',
                pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                pointBorderColor: '#fff',
                pointRadius: 0,
                pointHoverRadius: 0,
                borderCapStyle: 'round'
            },
            {
                label: 'Sensor 4',
                borderColor: 'rgb(77, 207, 80)',
                backgroundColor: 'rgb(77, 207, 80)',
                data: temp4,
                borderWidth: 3,
                borderJoinStyle: 'round',
                pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                pointBorderColor: '#fff',
                pointRadius: 0,
                pointHoverRadius: 0,
                borderCapStyle: 'round'
            },
            {
                label: 'Sensor 5',
                borderColor: 'rgb(255, 7, 208)',
                backgroundColor: 'rgb(255, 7, 208)',
                data: temp5,
                borderWidth: 3,
                borderJoinStyle: 'round',
                pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                pointBorderColor: '#fff',
                pointRadius: 0,
                pointHoverRadius: 0,
                borderCapStyle: 'round'
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }

    });


    var selectAtual = id_armazem.value;

    function gerarDados() {


        fetch("/armazem/gerarDados", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({

                idArmazem: selectAtual
            })
        })
            .then(function (respostas) {
                if (respostas.status == 500) {
                    alert("erro ao encontrar dados do armazem")
                } else {
                    if (respostas.ok) {
                        respostas.json()
                            .then(json => {
                                console.log(json)
                                sessionStorage.DadosGrafico = JSON.stringify(json)
                            })
                        setTimeout(() => {
                            var DadosGrafico = JSON.parse(sessionStorage.DadosGrafico)

                            atualizarGrafico(DadosGrafico)

                        }, 300)
                    }
                }
            })
    }
    // setTimeout(verificarSelects, 1000)

    function atualizarGrafico(DadosGrafico) {
        for (objeto = 0; DadosGrafico.resultadoS1.length > objeto; objeto++) {
            temp.push(DadosGrafico.resultadoS1[objeto].temperatura)
            temp2.push(DadosGrafico.resultadoS2[objeto].temperatura)
            temp3.push(DadosGrafico.resultadoS3[objeto].temperatura)
            temp4.push(DadosGrafico.resultadoS4[objeto].temperatura)
            temp5.push(DadosGrafico.resultadoS5[objeto].temperatura)

            data.push(DadosGrafico.resultadoS1[objeto].dtAtual)
        }
        myChart1.update()
        buscarDadoNovo()
    }

    function buscarDadoNovo() {
        var select = id_armazem.value;
        if (selectAtual != select) {
            selectAtual = select;
            temp.splice(0, temp.length)
            temp2.splice(0, temp2.length)
            temp3.splice(0, temp3.length)
            temp4.splice(0, temp4.length)
            temp5.splice(0, temp5.length)

            data.splice(0, data.length)

            gerarDados()

        } else {
            fetch("/armazem/buscarDadoNovo", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idArmazem: selectAtual
                })
            }).then(function(respostas){
                if(respostas == 400){

                }else if( respostas == 500){

                }else {
                    if(respostas.ok){
                        respostas.json()
                            .then(json => {
                                console.log(json)
                                sessionStorage.dadoNovo = JSON.stringify(json)
                            })
                            setTimeout(() => {
                            var dadoNovo = JSON.parse(sessionStorage.dadoNovo)

                            inserirDadoNovo(dadoNovo)

                        }, 300)
                    }
                }
            })
        }
    }

    function inserirDadoNovo(dadoNovo){
        // alert("chegou até aqui")
        if(temp.length >= 10){
            temp.splice(0,1)
            temp2.splice(0,1)
            temp3.splice(0,1)
            temp4.splice(0,1)
            temp5.splice(0,1)

            data.splice(0,1)
        }
        temp.push(dadoNovo[0].temperatura)
        temp2.push(dadoNovo[1].temperatura)
        temp3.push(dadoNovo[2].temperatura)
        temp4.push(dadoNovo[3].temperatura)
        temp5.push(dadoNovo[4].temperatura)

        data.push(dadoNovo[0].dtAtual)
     
        myChart1.update()
        setTimeout(buscarDadoNovo, 1000)
    }

</script>